---
name: Deploy

on:
  workflow_run:
    workflows:
    - Build
    branches:
    - main
    types:
    - completed

permissions:
  packages: write # for ghcr.io access

env:
  OCI_REPO: oci://ghcr.io/${{ github.actor }}/${{ github.event.repository.name }}

jobs:
  deploy:
    name: Production
    environment: prod
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-24.04

    steps:
    - name: Download manifests archive
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: DEBUG 0
      run: |
        find .

    - name: Install Flux
      uses: fluxcd/flux2/action@main

    - name: Sign in to GitHub container registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Detect manifests version
      id: ghd
      uses: proudust/gh-describe@v2

    - name: DEBUG 1
      run: |
        echo "TODO:"
        echo flux push artifact "$OCI_REPO:${{ steps.ghd.outputs.describe }}" \
          --path=. \
          --source="$(${git} config --get remote.origin.url)" \
          --revision="${{ steps.ghd.outputs.sha }}" \
          --reproducible

    - name: DEBUG 2
      run: |
        find .
