---
clusterName: dh8
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.6.5
# renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
kubernetesVersion: v1.29.2
endpoint: https://[fd10:8::ee8e:b5ff:fe6f:41d2]:6443
domain: dorn.haus
cniConfig:
  name: none
additionalApiServerCertSans: &sans
  - "::"  # api-server
  - "::1" # controller-manager, scheduler
additionalMachineCertSans: *sans
allowSchedulingOnControlPlanes: true

nodes:
  - hostname: k8s-01
    installDisk: /dev/sda
    controlPlane: true
    ipAddress: fd10:8::ee8e:b5ff:fe6f:41d2
    networkInterfaces:
    - deviceSelector:
        hardwareAddr: "*"
      dhcp: false
  - hostname: k8s-06
    installDisk: /dev/sda
    controlPlane: true
    ipAddress: fd10:8::468a:5bff:feca:9618
    networkInterfaces:
    - deviceSelector:
        hardwareAddr: "*"
      dhcp: false
  - hostname: k8s-07
    installDisk: /dev/sda
    controlPlane: true
    ipAddress: fd10:8::4637:e6ff:fe56:600e
    networkInterfaces:
    - deviceSelector:
        hardwareAddr: "*"
      dhcp: false

patches:
  - |-
    cluster:
      network:
        podSubnets:
          # IPv6-only:
          - fd10:244::/64
        serviceSubnets:
          # IPv6-only:
          - fd10:96::/108
      proxy:
        # Disable kube-proxy, since we're using
        # Cilium's kube-proxy replacement functionality.
        disabled: true
      apiServer:
        extraArgs:
          # Prefer IPv6 all interfaces.
          # TODO: Set up firewall rules to make sure this is not accessible
          # through the external interfaces (via the IPv6 pinholing setup.)
          bind-address: "::"
      controllerManager:
        extraArgs:
          # Prefer IPv6 loopback:
          bind-address: "::1"
      scheduler:
          extraArgs:
            # Prefer IPv6 loopback:
            bind-address: "::1"
    machine:
      time:
        servers:
        # IPv6-enabled:
        - time.cloudflare.com
      network:
        nameservers:
          - 2606:4700:4700::1001
          - 2001:4860:4860::8844
        extraHostEntries:
          - ip: fd10:8::ba27:ebff:fe69:d702
            aliases:
              - jh
              - jh.dorn.haus
      # Prevent the kubelet from using any other address range.
      # Otherwise the kubelet might pick the auto-configured ::ffff:0:0/96
      # range, which has no routes configured.
      kubelet:
        nodeIP:
          validSubnets:
            - fd10:8::/64
      env:
        http_proxy: &proxy "jh:3128"
        https_proxy: *proxy
