# https://artifacthub.io/packages/helm/bitnami/keycloak#parameters
inputs @ {
  k,
  cluster,
  ...
}: let
  inherit (cluster) domain;
  issuer = import ../../../cert-manager/cert-manager/config/cluster-issuer.yaml.nix inputs;

  name = k.appname ./.;
  namespace = k.nsname ./.;
in rec {
  production = true;

  # Use our own database.
  postgresql.enabled = false;
  # CloudNative PG managed cluster.
  externalDatabase = {
    existingSecret = "${k.fluxcd.ksname ../database}-app";
    existingSecretHostKey = "host";
    existingSecretPortKey = "port";
    existingSecretUserKey = "user";
    existingSecretDatabaseKey = "dbname";
    existingSecretPasswordKey = "password";
  };

  tls = {
    enabled = true;
    autoGenerated = true;
  };

  ingress = rec {
    enabled = true;
    ingressClassName = "nginx";
    hostname = domain;
    path = "/${name}";
    annotations = {
      # TLS
      "cert-manager.io/cluster-issuer" = issuer.metadata.name;
      # NGINX
      # TODO: Configure mTLS between ingress controller & keycloak: https://www.keycloak.org/server/mutual-tls
      "nginx.ingress.kubernetes.io/backend-protocol" = "HTTPS";
      "nginx.ingress.kubernetes.io/proxy-ssl-name" = name;
      "nginx.ingress.kubernetes.io/proxy-ssl-secret" = "${namespace}/${name}-crt";
      "nginx.ingress.kubernetes.io/proxy-ssl-server-name" = "on";
      "nginx.ingress.kubernetes.io/proxy-ssl-verify" = "on";
      # Homepage
      "gethomepage.dev/enabled" = "true";
      "gethomepage.dev/name" = "Keycloak";
      "gethomepage.dev/description" = "Identity provider";
      "gethomepage.dev/group" = "Cluster Management";
      "gethomepage.dev/icon" = "keycloak.svg";
    };

    tls = production;
    servicePort =
      if tls
      then "https"
      else "http";
  };
  proxyHeaders = "forwarded";
  httpRelativePath = "${ingress.path}/";
}
